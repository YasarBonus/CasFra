<!DOCTYPE html>
<html>
    <%- include('../partials/head') %>
    <%- include('../partials/header') %>
    <body class="bg-yasarred" >
        <div class="ui container" style="margin-top: 100px !important; padding-bottom: 100px;">
            <div class="ui segment" >
                <%- include('./partials/dashboard-menu') %>
                <div class="ui segment">
                    <h2>Casino Payment Methods</h2>
                        <table id="casinoPaymentMethodsTable" class="ui celled table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Priority (Sorting)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be dynamically added here -->
                            </tbody>
                        </table>
                        <div class="ui green button" id="saveAllBtn">Save All</div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../partials/footer') %>

        <!-- Fomantic UI small modal -->
        <div id="deleteModal" class="ui small modal">
            <div class="header">Delete Payment Method</div>
            <div class="content">
                <p>Are you sure you want to delete this payment method?</p>
            </div>
            <div class="actions">
                <div class="ui negative button">Cancel</div>
                <div class="ui positive button" id="confirmDeleteBtn">Delete</div>
            </div>
        </div>
    </body>
</html>

<script>
    $(document).ready(function() {
        // Function to load initial data from API endpoint
        function loadInitialData() {
            // Clear the table
            $('#casinoPaymentMethodsTable tbody').empty();

            $.ajax({
                url: '/api/v1/casinos/paymentmethods',
                method: 'GET',
                success: function(data) {
                    // Sort the payment methods by priority
                    data.sort(function(a, b) {
                        return a.priority - b.priority;
                    });

                    // Populate the table with data
                    data.forEach(function(paymentMethod) {
                        var row = '<tr id="' + paymentMethod._id + '">' +
                            '<td>' +
                            '<div class="ui fluid search selection dropdown image-dropdown">' +
                            '<input type="hidden" name="image">' +
                            '<i class="dropdown icon"></i>' +
                            '<div class="default text">Select an image</div>' +
                            '<div class="menu">';

                        // Fetch available images from /api/v1/images
                        $.ajax({
                            url: '/api/v1/images',
                            method: 'GET',
                            success: function(images) {
                                // Add options to the dropdown
                                images.forEach(function(image) {
                                    var option = '<div class="item" data-value="' + image._id + '"><img class="ui image" src="' + image.imageUrl + '">' + image.name + '</div>';
                                    row += option;
                                });

                                // Set the selected image based on paymentMethod.image
                                row += '</div>' +
                                    '</div>' +
                                    '</td>' +
                                    '<td contenteditable="true">' + paymentMethod.name + '</td>' +
                                    '<td contenteditable="true">' + paymentMethod.description + '</td>' +
                                    '<td contenteditable="true">' + paymentMethod.priority + '</td>' +
                                    '<td>' +
                                    '<button class="ui small blue button duplicate-btn">Duplicate</button>' +
                                    '<button class="ui small red button delete-btn">Delete</button>' +
                                    '</td>' +
                                    '</tr>';

                                $('#casinoPaymentMethodsTable tbody').append(row);
                                // Set the selected image based on paymentMethod.image
                                $('#' + paymentMethod._id + ' .image-dropdown').dropdown('set selected', paymentMethod.image);
                            },
                            error: function(error) {
                                console.log('Error:', error);
                            }
                        });
                    });
                },
                error: function(error) {
                    console.log('Error:', error);
                }
            });
        }

        // Call the function to load initial data
        loadInitialData();

        // Event listener for duplicate button
        $(document).on('click', '.duplicate-btn', function() {
            var paymentMethodId = $(this).closest('tr').attr('id');
            duplicatePaymentMethod(paymentMethodId);
        });

        // Event listener for delete button
        $(document).on('click', '.delete-btn', function() {
            var paymentMethodId = $(this).closest('tr').attr('id');
            showDeleteModal(paymentMethodId);
        });

        // Event listener for confirm delete button
        $(document).on('click', '#confirmDeleteBtn', function() {
            var paymentMethodId = $(this).closest('.modal').data('paymentMethodId');
            deletePaymentMethod(paymentMethodId);
            $('#deleteModal').modal('hide');
        });

        // Event listener for save all button
        $(document).on('click', '#saveAllBtn', function() {
            saveAllPaymentMethods();
        });

        // Function to duplicate a payment method
        function duplicatePaymentMethod(paymentMethodId) {
            $.ajax({
                url: '/api/v1/casinos/paymentmethods/' + paymentMethodId + '/duplicate',
                method: 'POST',
                success: function(data) {
                    loadInitialData();
                },
                error: function(error) {
                    console.log('Error:', error);
                }
            });
        }

        // Function to save a payment method
        function savePaymentMethod(paymentMethodId) {
            $.ajax({
                url: '/api/v1/casinos/paymentmethods/' + paymentMethodId,
                method: 'PUT',
                data: {
                    name: $('#' + paymentMethodId + ' td:nth-child(2)').text(),
                    description: $('#' + paymentMethodId + ' td:nth-child(3)').text(),
                    priority: $('#' + paymentMethodId + ' td:nth-child(4)').text(),
                    image: $('#' + paymentMethodId + ' .image-dropdown').dropdown('get value')
                },
                success: function(data) {
                    console.log('Success:', data);
                },
                error: function(error) {
                    console.log('Error:', error);
                }
            });
        }

        // Function to save all payment methods
        function saveAllPaymentMethods() {
            $('#casinoPaymentMethodsTable tbody tr').each(function() {
                var paymentMethodId = $(this).attr('id');
                savePaymentMethod(paymentMethodId);
            });
            loadInitialData();
        }

        // Function to delete a payment method
        function deletePaymentMethod(paymentMethodId) {
            $.ajax({
                url: '/api/v1/casinos/paymentmethods/' + paymentMethodId,
                method: 'DELETE',
                success: function(data) {
                    console.log('Payment method deleted successfully');
                    loadInitialData();
                },
                error: function(error) {
                    console.log('Error:', error);
                }
            });
        }

        // Function to show delete modal
        function showDeleteModal(paymentMethodId) {
            $('#deleteModal').data('paymentMethodId', paymentMethodId).modal('show');
        }

    });
</script>
