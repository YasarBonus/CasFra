<!DOCTYPE html>
<html>
    <%- include('../partials/head') %>
    <%- include('../partials/header') %>
    <body class="bg-yasarred" >
        <div class="ui container" style="margin-top: 100px !important; padding-bottom: 100px;">
            <div class="ui segment" >
                <%- include('./partials/dashboard-menu') %>
                <div class="ui segment">
                    <h2>Images</h2>
                    <form id="uploadForm" enctype="multipart/form-data" class="ui form">
                        <div class="field">
                            <label for="imageInput">Choose an image:</label>
                            <input type="file" name="image" id="imageInput">
                        </div>
                        <button class="ui primary button" type="submit">Upload</button>
                    </form>
                    <div id="imageCards" class="ui cards"></div>
                </div>
            </div>
        </div>
        <%- include('../partials/footer') %>

        <script>
            // Function to fetch and display existing images
            function fetchImages() {
                fetch('/api/images')
                    .then(response => response.json())
                    .then(data => {
                        // Clear existing cards
                        document.getElementById('imageCards').innerHTML = '';

                        // Add each image as a card
                        data.forEach(image => {
                            var card = document.createElement('div');
                            card.className = 'ui card';

                            var imageElement = document.createElement('img');
                            imageElement.src = image.imageUrl;
                            imageElement.style.maxWidth = '200px';
                            card.appendChild(imageElement);

                            var content = document.createElement('div');
                            content.className = 'content';
                            card.appendChild(content);

                            var nameInput = document.createElement('input');
                            nameInput.type = 'text';
                            nameInput.value = image.name;
                            content.appendChild(nameInput);

                            var imageId = document.createElement('div');
                            imageId.classList = 'ui label';
                            imageId.textContent = image._id;
                            content.appendChild(imageId);

                            // Add click event listener to copy image ID to clipboard
                            imageId.addEventListener('click', function() {
                                // Create a temporary input element
                                var tempInput = document.createElement('input');
                                tempInput.value = image._id;
                                document.body.appendChild(tempInput);

                                // Copy the value to clipboard
                                tempInput.select();
                                document.execCommand('copy');

                                // Remove the temporary input element
                                document.body.removeChild(tempInput);

                                // Show a notification or perform any other action to indicate successful copy
                                console.log('Image ID copied to clipboard: ' + image._id);
                                showToast('success', 'Image ID copied to clipboard: ', image._id);
                            });

                            var actions = document.createElement('div');
                            actions.className = 'extra content';
                            card.appendChild(actions);

                            var saveButton = document.createElement('button');
                            saveButton.className = 'ui primary button';
                            saveButton.textContent = 'Save';
                            saveButton.addEventListener('click', function() {
                                // Save the image name
                                var newName = nameInput.value;
                                // Send a request to update the image name
                                fetch('/api/images/' + image._id, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ name: newName })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    // Handle response from the server
                                    console.log(data);
                                    // Update the image name in the card
                                    image.name = newName;
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });
                            });
                            actions.appendChild(saveButton);

                            var deleteButton = document.createElement('button');
                            deleteButton.className = 'ui red button';
                            deleteButton.textContent = 'Delete';
                            deleteButton.addEventListener('click', function() {
                                // Send a request to delete the image
                                fetch('/api/images/' + image._id, {
                                    method: 'DELETE'
                                })
                                .then(response => response.json())
                                .then(data => {
                                    // Handle response from the server
                                    console.log(data);
                                    // Remove the card from the container
                                    card.remove();
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });
                            });
                            actions.appendChild(deleteButton);

                            document.getElementById('imageCards').appendChild(card);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            // AJAX form submission
            document.getElementById('uploadForm').addEventListener('submit', function(event) {
                event.preventDefault();
                var formData = new FormData(this);
                fetch('/api/images', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Handle response from the server
                    console.log(data);
                    fetchImages();

                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });

            // Fetch and display existing images on page load
            fetchImages();
        </script>
    </body>
</html>
