<!-- sessions.ejs -->
<!DOCTYPE html>
<html>
    <%- include('../partials/head') %>
    <%- include('../partials/header') %>
    <body class="bg-yasarred">
        <div class="ui container" style="margin-top: 100px !important; padding-bottom: 100px;">
            <div class="ui segment">
                <%- include('./partials/dashboard-menu') %>
                <div class="ui segment">
                <div class="ui container">
                    <h2>ShortLinks</h2>
                    <div class="ui segment">
                        <div class="ui form">
                            <div class="three fields">
                            <div class="field">
                                <label>ShortUrl</label>
                                <input type="text" id="shortUrlInput" placeholder="ShortUrl">
                            </div>
                            <div class="field">
                                <label>Url</label>
                                <input type="text" id="urlInput" placeholder="Url">
                            </div>
                            <div class="field">
                                <label>Description</label>
                                <input type="text" id="descriptionInput" placeholder="Description">
                            </div>
                        </div>
                            <div class="ui green button" id="addLinkBtn">Add Link</div>
                        </div>
                    </div>
                    <table id="shortlinksTable" class="ui celled table">
                        <thead>
                            <tr>
                                <th>ShortUrl</th>
                                <th>Url</th>
                                <th>Description</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
</html>

<div class="ui small modal delete">
    <div class="header">
        Delete Link
    </div>
    <div class="content">
        <p>Are you sure you want to delete this link?</p>
    </div>
    <div class="actions">
        <div class="ui red cancel button">
            <i class="remove icon"></i>
            No
        </div>
        <div class="ui green approve button">
            <i class="checkmark icon"></i>
            Yes
        </div>
    </div>

<script>

    function loadInitialData() {
        // Clear the table
        $('#shortlinksTable tbody').empty();

        $.ajax({
            url: '/api/shortlinks',
            method: 'GET',
            success: function(data) {
                // Sort the links by created date
                data.sort(function(a, b) {
                    return new Date(b.created) - new Date(a.created);
                });

                // Populate the table with data
                data.forEach(function(link) {
                    var row = '<tr id="' + link._id + '">' +
                        '<td contenteditable="true">' + link.shortUrl + '</td>' +
                        '<td contenteditable="true">' + link.url + '</td>' +
                        '<td contenteditable="true">' + link.description + '</td>' +
                        '<td>' + link.created + '</td>' +
                        '<td>' +
                        '<button class="ui small red button delete-btn">Delete</button>' +
                        '<button class="ui small green button save-btn">Save</button>' +
                        '</td>' +
                        '</tr>';
                    $('#shortlinksTable tbody').append(row);
                });
            }
        });
    } 

    // Event listener for save button
    $('#shortlinksTable').on('click', '.save-btn', function() {
        var id = $(this).closest('tr').attr('id');
        var shortUrl = $(this).closest('tr').find('td:nth-child(1)').text();
        var url = $(this).closest('tr').find('td:nth-child(2)').text();
        var description = $(this).closest('tr').find('td:nth-child(3)').text();

        saveLink(id, shortUrl, url, description);
    });

    // Function to save a link
    function saveLink(id, shortUrl, url, description) {
        $.ajax({
            url: '/api/shortlinks/' + id,
            method: 'PUT',
            data: {
                shortUrl: shortUrl,
                url: url,
                description: description
            },
            success: function(data) {
                console.log('Success:', data);
                showToast('success', 'Link saved successfully');
                loadInitialData();
            },
            error: function(error) {
                console.log('Error:', error);
                showToast('error', 'Error saving link');
                loadInitialData();
                document.querySelector('.ui.modal').scrollTop = 0;
            }
        });
    } 

    // Event listener for add link button
    $('#addLinkBtn').on('click', function() {
        var shortUrl = $('#shortUrlInput').val();
        var url = $('#urlInput').val();
        var description = $('#descriptionInput').val();

        addLink(shortUrl, url, description);
    });

    // Function to add a link
    function addLink(shortUrl, url, description) {
        $.ajax({
            url: '/api/shortlinks',
            method: 'POST',
            data: {
                shortUrl: shortUrl,
                url: url,
                description: description
            },
            success: function(data) {
                console.log('Success:', data);
                showToast('success', 'Link added successfully');
                loadInitialData();
            },
            error: function(error) {
                console.log('Error:', error);
                showToast('error', 'Error adding link');
                loadInitialData();
                document.querySelector('.ui.modal').scrollTop = 0;
            }
        });
    }

    // Event listener for delete button
    $('#shortlinksTable').on('click', '.delete-btn', function() {
        var id = $(this).closest('tr').attr('id');
        var shortUrl = $(this).closest('tr').find('td:nth-child(1)').text();
        var url = $(this).closest('tr').find('td:nth-child(2)').text();
        var description = $(this).closest('tr').find('td:nth-child(3)').text();

        showDeleteDialog(id, shortUrl, url, description);
    });

    // Function to show delete dialog
    function showDeleteDialog(id, shortUrl, url, description) {
        $('.ui.modal.delete')
            .modal({
                closable: true,
                onApprove: function() {
                    deleteLink(id);
                }
            })
            .modal('show');
    }

    // Function to delete a link
    function deleteLink(id) {
        $.ajax({
            url: '/api/shortlinks/' + id,
            method: 'DELETE',
            success: function(data) {
                console.log('Success:', data);
                showToast('success', 'Link deleted successfully');
                loadInitialData();
            },
            error: function(error) {
                console.log('Error:', error);
                showToast('error', 'Error deleting link');
                loadInitialData();
                document.querySelector('.ui.modal').scrollTop = 0;
            }
        });
    }

    loadInitialData();

</script>