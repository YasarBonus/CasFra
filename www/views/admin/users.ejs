<!-- media.ejs -->
<!DOCTYPE html>
<html>
    <%- include('../partials/head') %>
    <%- include('../partials/header') %>
    <body class="bg-yasarred">
        <div class="ui container" style="margin-top: 100px !important; padding-bottom: 100px;">
            <div class="ui segment">
                <%- include('./partials/dashboard-menu') %>
                <div class="ui segment">
                    <div class="ui container">
                        <h2>Users</h2>
                        <table id="usersTable" class="ui celled table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Group</th>
                                    <th>Registration Date</th>
                                    <th>Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../partials/footer') %>
        <script>
            $(document).ready(function() {
                // Function to handle delete button click
                function deleteUser(userId) {
                    $.ajax({
                        url: '/api/users/',
                        method: 'DELETE',
                        data: {
                            id: userId
                        },
                        success: function(response) {
                            console.log('User deleted successfully');
                            showToast('success', 'User deleted successfully', 'The user was successfully deleted.');
                            // Refresh the table after deletion
                            getUsers();
                        },
                        error: function(error) {
                            console.log('Error deleting user:', error);
                            showToast('error', 'Error deleting user', 'There was an error deleting the user. Please try again. This incident has been logged.');
                        }
                    });
                }

                // Function to get users and populate the table
                function getUsers() {
                    $.ajax({
                        url: '/api/users',
                        method: 'GET',
                        dataType: 'json', // Specify the expected data type as JSON
                        success: function(data) {
                            var users = data;
                            var tableBody = $('#usersTable tbody');
                            tableBody.empty();
                            users.forEach(function(user) {
                                var row = $('<tr>');
                                row.append($('<td>').text(user._id));
                                row.append($('<td>').text(user.username));
                                row.append($('<td>').text(user.email));
                                row.append($('<td>').text(user.groupId));
                                row.append($('<td>').text(user.registrationDate));
                                row.append($('<td>').text(user.active));
                                var actions = $('<td>');
                                var deleteButton = $('<div class="ui tiny red button">').text('Delete');
                                // Add click event listener to delete button
                                deleteButton.click(function() {
                                    deleteUser(user._id);
                                });
                                actions.append(deleteButton);
                                row.append(actions);
                                tableBody.append(row);
                            });
                        },
                        error: function(error) {
                            console.log('Error:', error);
                        }
                    });
                }

                // Initial load of users
                getUsers();
            });
        </script>
    </body>
</html>
